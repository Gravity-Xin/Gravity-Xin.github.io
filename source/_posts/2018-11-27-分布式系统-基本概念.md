---
title: 分布式系统-基本概念
date: 2018-11-27 14:47:38
categories:
- Distributed System
tags:
- CAP
- BASE
comments: true
---

分布式系统是一个由硬件或软件组件分布在不同的网络计算机上，彼此之间仅仅通过消息传递进行通信和协调的系统

## 特点

* 数据副本/服务副本

* 总会出现故障

通信异常，导致节点间的通信存在成功、失败、超时三种状态
网络分区，导致只有部分节点之间可以正常的通信，出现局部的小集群
节点本身故障，服务本身宕机或者异常

* 从ACID到分布式事务

ACID指的是数据库事务需要满足的条件，即原子性、一致性、隔离性和持久性
对应到分布式系统中变为分布式事务，分布式事务可以看做是由多个分布式的操作序列

* 从CAP到BASE

CAP理论指的是分布式系统不可能同时满足一致性、可用性和分区容错性
BASE指的是基本可用，弱状态和最终一致性
基本可用：分布式系统出现故障时，允许损失部分可用性，如响应时间的损失或功能的损失
弱状态：允许节点之间的数据同步存在一定的延时
最终一致性：要求副本数据节点在经过一段时间的同步后，最终达到一致

## 一致性协议

当一个分布式操作需要跨越多个节点时，为了保证一致性，需要引入一个协调者来统一管理多个节点的操作结果，并最终决定该事务是否可以被提交，由此衍生出了两阶段提交和三阶段提交的协议

* 2PC与3PC
  * 2PC
    * 准备阶段(投票阶段)
      * 协调者向所有参与者询问是否可以执行提交操作，并等待参与者的响应
      * 参与者**执行该操作**，并将Redo(重做)和Undo(撤销)信息记录 **从前向后读取Redo，重做所有已提交的事务，从后往前读取Undo，回滚未提交的事务**
      * 参与者响应协调者，如果执行操作成功则返回“ACK”
    * 提交阶段
      * 如果所有参与者的响应都是"ACK”
        * 协调者向所有参与者发送“COMMIT”消息
        * 参与者释放当前操作占用的资源
        * 参与者向协调者发送“ACK”的消息
        * 协调者在收到所有参与者完成的消息之后，结束该事务
      * 如果有任一参与者响应不是ACK或者参与者的响应超时
        * 协调者节点向所有参与者发送“ABORT”消息
        * 参与者利用之前的Undo记录进行回滚操作，并释放当前操作占用的资源
        * 参与者向协调者发送“ACK“的消息
        * 协调者收到所有参与者ACK的消息之后，结束该事务
    * 存在的问题
      * 单点故障：协调者发生故障，导致参与者处于资源锁定的状态，且分布式事务无法完成
      * 数据不一致：协调者发送COMMIT消息时出现故障，导致只有部分参与者接收到COMMIT消息时，可能各个参与者的数据可能不一致
  * 3PC:
    * 准备阶段(CanCommit)
      * 协调者向参与者询问是否可以执行提交操作，并等待参与者的响应
      * 参与者根据自身状态，判断是否可以执行该操作，如果可以则返回”ACK“响应
    * 预提交阶段(PreCommit)
      * 如果所有参与者的响应都是”ACK“
        * 协调者向所有参与者发送”PRECOMMIT“请求
        * 参与者收到预提交请求之后，**执行该操作**，并Redo和Undo信息记录
        * 如果参与者成功执行操作，则向协调者返回”ACK“，同时等待协调者最终的指令
      * 如果任一参与者的响应不是ACK或者参与者的响应超时
        * 协调者向所有参与者发送”ABORT“请求
        * 参与者收到了协调者的ABORT请求或者等待超时之后，执行事务的中断操作
    * 提交阶段(DoCommit)
      * 如果协调者收到了所有参与的ACK响应
        * 协调者向所有参与者发送”DOCOMMIT“请求
        * 参与者收到提交请求之后，释放当前操作占用的资源，并向协调者发送ACK消息
        * 协调者在收到所有参与者的ACK消息后，结束该事务
      * 如果协调者没有收到任一参与者的ACK响应
        * 协调者向所有参与者发送”ABORT“请求
        * 参与者收到ABORT请求后，利用Undo记录执行回滚操作，并向协调者发送ACK消息
        * 协调者收到所有参与者的ACK消息后，结束该事务

2PC和3PC其实都没有真正解决分布式一致性的问题

* Paxos与Raft