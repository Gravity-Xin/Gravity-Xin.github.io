---
title: Mysql基础
date: 2019-03-12 10:57:10
categories: 
- 系统架构
tags: 
- mysql
- index
- InnoDB
- MyISAM
comments: true
---

- 逻辑架构
  - 客户端
  - 服务器
  - 存储引擎
    - InnoDB
      - mysql默认事务型引擎
      - 处理大量短期事务，应该优先考虑使用该引擎
      - 支持行锁和表锁
      - 支持事务和自动崩溃恢复
      - 索引文件和数据文件相同，根据主键查询为聚簇索引，索引data域为具体行数据；根据其它字段查询为非聚簇索引，索引data域为主键值，再根据主键的索引找到具体行
    - MyISAM
      - 支持表锁
      - 不支持事务和自动崩溃恢复
      - 索引文件和数据文件分离，索引data域为行的地址，为非聚簇索引；主键索引与其它字段的索引格式一样，都是非聚簇索引
- 并发请求控制
  - 读写锁
  - 表锁与行锁
- 事务
  - ACID特性
  - 隔离级别: 一个事务中所做的修改对于其他事务的可见性
    - READ UNCOMMITED: 未提交读 发生脏读的情况
    - READ COMMITED: 提交读 发生不可重复读的情况
    - REPEATABLE READ: 可重复读 解决了脏读的问题，还使用MVCC多版本控制来解决幻读的问题  **mysql默认的隔离级别**
    - SERIALIZABLE 可串行化 事务串行执行
  - 死锁: 多个事务互相等待对方占用的锁
  - 使用事务日志来提高事务的执行效率，不直接改磁盘上的数据，而是记录事务日志，然后在后台慢慢将数据刷回到磁盘
  - AUTOCOMMIT: 在InnoDB中，如果没有显式开始事务，则自动将每一个sql操作当做事务进行提交

| 隔离级别  | 脏读（Dirty Read）  |  不可重复读（NonRepeatable Read） | 幻读（Phantom Read）|
|----------|--------------------|---------------------------------|-------------------|
|  未提交读 |      可能           |        可能                     |    可能            |
|  已提交读 |      不可能         |        可能                     |     可能            |
|  可重复读 |      不可能         |        不可能                   |     可能            |
|  可串行化 |      不可能         |        不可能                   |     不可能          |

- 多版本并发控制(MVCC): 保存数据在某个时间点的快照，使用乐观锁的方式
  - InnoDB在每行记录中添加额外的两个隐藏的列(创建时间和删除时间)来实现MVCC
- 索引
  - 使用索引会降低增删改的速度，因为需要维护索引
  - 分类
    - 主键索引 PRIMARY KEY
    - 唯一索引 UNIQUE
    - 普通索引 INDEX
    - 组合索引 INDEX
    - 全文索引 FULLTEXT
  - 实现机制
    - B+树
      - 磁盘IO次数为树的高度
      - 多个树节点占用磁盘一页的空间，可以利用磁盘缓存和访问局部性原理提高IO效率
    - 哈希
      - 每次只查询出一行，不支持范围查询
  - 优化
    - 使用explain命令定位性能瓶颈
      - 是否为全表扫描
      - 用了哪些索引
    - 索引的字段应尽量的小，减少单个索引占用的磁盘空间，从而可以增加磁盘上一页中的树节点数量，从而减少磁盘IO次数
    - 组合索引与最左前缀匹配原理
      - 创建组合索引时，将使用最频繁的列放在左边
      - 使用组合索引查询时，where子句将使用最频繁的列放在最左边
    - 使用区分度高的列作为索引
- SQL语句执行顺序: `select -- from -- where -- group by -- having -- order by`
  - from: 确定从哪些表中进行检索，多个表的执行顺序是从后往前，因此需要将数据量较少的表放到最后
  - where: 确定表中数据的过滤条件，多个过滤条件的执行顺序是从后往前，因此可以过滤到最多数据的条件应放到最后 **过滤条件对应的字段是表中所有的字段，过滤条件不能使聚合函数**
  - group by: 确定过滤出的数据的数据分组
  - having: 对已经分组的数据设置过滤条件 **过滤条件对应的字段是表中被select查询出来的字段，过滤条件一般是聚合函数，一般配合分组进行使用**
  - select: 获取符合条件的数据结果集
  - order by: 对数据结果集进行排序，执行顺序为从前往后
- 大表优化
  - 限制查询范围
  - 读写分离
  - 缓存
  - 垂直拆分: 根据表中内容的相关性拆分为几张表
  - 水平拆分: 按照某个字段进行分片