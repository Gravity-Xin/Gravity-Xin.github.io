---
title: Golang-defer
date: 2019-02-15 11:10:26
categories:
- 编程技术
tags:
- defer
- 闭包
- recover
comments: true
---

defer语句是Golang提供的一种用于`注册延时调用`的机制，可以让函数或者语句在当前函数执行完毕后`正常return和异常panic`执行

- 使用场景

一般defer语句用在资源回收的场景下，如关闭文件、释放锁、关闭连接等，如

```Go
f, err := os.Open(filename)
if err != nil{
    panic(err)
}
if f != nil{
    defer f.Close()
}
```

- 底层原理

defer语句在进行注册时，将注册的语句或函数压入到一个栈中，在当前函数return前，以`先进后出`的顺序执行，原因在于后面注册的语句或函数有可能依赖前面的资源，即资源的释放顺序应该与资源的申请顺序相反

defer注册的语句或函数对外部变量的引用有两种方式，分别作为`函数参数`或`闭包引用`。在作为函数参数时，`在defer定义处就将变量当前值传递给defer，并且被缓存起来`；在作为闭包引用时，则`在注册的语句或函数真正调用时根据整个上下文确定变量当前值`。 **函数参数中使用的是值传递；闭包中捕获的常量和变量都是引用传递**

当变量以函数参数的形式被defer使用时，如果变量是值类型，则变量的值与defer定义时一致；如果变量是一个引用类型(如slice、map、chan或指针)时，虽然将变量当前值缓存了，但是引用指向的值可能会有变化

defer注册的语句或函数在return之前执行，实际执行流程是

```shell
返回值 = xxx
调用defer注册的语句或函数
空的return
```

- 配合recover，实现异常处理
